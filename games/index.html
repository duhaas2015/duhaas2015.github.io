<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheepshead Score Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c5530, #1a4d1a);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .setup-section, .game-section {
            margin-bottom: 30px;
        }

        .setup-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, button, select {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        input {
            width: 100%;
            max-width: 300px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .player-tag {
            background: #2196F3;
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-player {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        .scoreboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .score-table th,
        .score-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .score-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .score-input {
            width: 80px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .hand-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .hand-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-group h4 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }
        
        .form-row label {
            margin-bottom: 0;
            min-width: 80px;
            font-size: 14px;
        }
        
        .form-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .form-row select {
            flex: 1;
            min-width: 120px;
        }
        
        .wrap-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .wrap-controls input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .wrap-controls label {
            margin: 0;
            font-size: 14px;
        }
        
        .wrap-by {
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .wrap-by label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }
        
        .wrap-by select {
            padding: 5px 8px;
            font-size: 12px;
            min-width: 100px;
        }

        .picker-partner {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .hidden {
            display: none;
        }

        .totals {
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #f44336;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .nav-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #fff;
            border-bottom-color: #4CAF50;
        }

        .nav-tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .session-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .session-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .session-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .session-players {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c5530, #1a4d1a);
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .hand-controls {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêë Sheepshead Score Tracker</h1>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('current')">Current Game</button>
            <button class="nav-tab" onclick="showTab('history')">Game History</button>
            <button class="nav-tab" onclick="showTab('stats')">All-Time Stats</button>
        </div>

        <div id="currentTab" class="tab-content active">
        <div id="setup" class="setup-section">
            <h2>Game Setup</h2>
            <div class="input-group">
                <label for="playerName">Add Player:</label>
                <input type="text" id="playerName" placeholder="Enter player name">
                <button onclick="addPlayer()">Add Player</button>
            </div>
            
            <div class="players-list" id="playersList"></div>
            
            <button onclick="startGame()" id="startBtn" disabled>Start Game</button>
        </div>

        <div id="gameSection" class="game-section hidden">
            <div class="hand-section">
                <h3>Current Hand</h3>
                <div class="hand-controls">
                    <div class="control-group">
                        <h4>Basic Hand Info</h4>
                        
                        <div class="form-row">
                            <label for="picker">Picker:</label>
                            <select id="picker" onchange="updatePartnerOptions()">
                                <option value="">Select Picker</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="partner">Partner:</label>
                            <select id="partner">
                                <option value="">Select Partner</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="calledSuit">Called:</label>
                            <select id="calledSuit">
                                <option value="">Select Called Suit</option>
                                <option value="Hearts">Hearts</option>
                                <option value="Spades">Spades</option>
                                <option value="Clubs">Clubs (non-trump)</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="pickerPoints">Points:</label>
                            <input type="number" id="pickerPoints" min="0" max="120" placeholder="0-120">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Wrap Status</h4>
                        
                        <div class="wrap-controls">
                            <input type="checkbox" id="wrapped">
                            <label for="wrapped">Wrapped (doubled)</label>
                        </div>
                        <div class="wrap-by">
                            <label for="wrappedBy">By:</label>
                            <select id="wrappedBy">
                                <option value="">Who wrapped?</option>
                            </select>
                        </div>
                        
                        <div class="wrap-controls">
                            <input type="checkbox" id="reWrapped">
                            <label for="reWrapped">Re-wrapped (re-doubled)</label>
                        </div>
                        <div class="wrap-by">
                            <label for="reWrappedBy">By:</label>
                            <select id="reWrappedBy">
                                <option value="">Who re-wrapped?</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button onclick="scoreHand()">Score Hand</button>
                <button onclick="clearHand()">Clear Hand</button>
            </div>

            <div class="scoreboard">
                <h3>Scoreboard</h3>
                <table class="score-table" id="scoreTable">
                    <thead>
                        <tr>
                            <th>Hand</th>
                        </tr>
                    </thead>
                    <tbody id="scoreBody">
                    </tbody>
                </table>
            </div>

            <div class="scoreboard">
                <h3>Player Statistics</h3>
                <table class="score-table" id="statsTable">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Record</th>
                            <th>Win %</th>
                            <th>Times Picked</th>
                            <th>Times Partner</th>
                            <th>Avg Score/Hand</th>
                        </tr>
                    </thead>
                    <tbody id="statsBody">
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="saveSession()">Save Session</button>
                <button onclick="newGame()">New Game</button>
                <button onclick="exportGame()">Export Current Game</button>
            </div>
        </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="setup-section">
                <h2>Game History</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="loadHistoricalData()">Refresh</button>
                    <button onclick="exportAllData()">Export All Data</button>
                    <button onclick="importData()">Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                </div>
                <div id="sessionsList"></div>
            </div>
        </div>

        <div id="statsTab" class="tab-content">
            <div class="setup-section">
                <h2>All-Time Player Statistics</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="calculateAllTimeStats()">Refresh Stats</button>
                </div>
                <div id="allTimeStats"></div>
            </div>
        </div>

        <!-- Session Detail Modal -->
        <div id="sessionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSessionModal()">&times;</span>
                <div id="sessionDetail"></div>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let hands = [];
        let currentHand = 1;
        let playerStats = {};
        let currentSessionId = null;
        let gameStartTime = null;

        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (name && !players.includes(name)) {
                players.push(name);
                updatePlayersList();
                nameInput.value = '';
                updateStartButton();
            }
        }

        function removePlayer(name) {
            players = players.filter(p => p !== name);
            updatePlayersList();
            updateStartButton();
        }

        function updatePlayersList() {
            const list = document.getElementById('playersList');
            list.innerHTML = players.map(player => 
                `<div class="player-tag">
                    ${player}
                    <button class="remove-player" onclick="removePlayer('${player}')">√ó</button>
                </div>`
            ).join('');
        }

        function updateStartButton() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = players.length < 5;
        }

        function startGame() {
            if (players.length < 5) return;
            
            gameStartTime = new Date().toISOString();
            currentSessionId = generateSessionId();
            initializePlayerStats();
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            setupGameInterface();
        }

        function setupGameInterface() {
            const picker = document.getElementById('picker');
            const partner = document.getElementById('partner');
            const wrappedBy = document.getElementById('wrappedBy');
            const reWrappedBy = document.getElementById('reWrappedBy');
            
            const playerOptions = players.map(p => `<option value="${p}">${p}</option>`).join('');
            
            picker.innerHTML = '<option value="">Select Picker</option>' + playerOptions;
            wrappedBy.innerHTML = '<option value="">Who wrapped?</option>' + playerOptions;
            reWrappedBy.innerHTML = '<option value="">Who re-wrapped?</option>' + playerOptions;
            
            setupScoreTable();
        }

        function updatePartnerOptions() {
            const picker = document.getElementById('picker').value;
            const partner = document.getElementById('partner');
            
            partner.innerHTML = '<option value="">Select Partner</option>' +
                players.filter(p => p !== picker)
                    .map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function setupScoreTable() {
            const table = document.getElementById('scoreTable');
            const thead = table.querySelector('thead tr');
            const tbody = document.getElementById('scoreBody');
            
            thead.innerHTML = '<th>Hand</th>' + 
                players.map(p => `<th>${p}</th>`).join('') +
                '<th>Details</th>';
            
            updateScoreTable();
        }

        function scoreHand() {
            const picker = document.getElementById('picker').value;
            const partner = document.getElementById('partner').value;
            const points = parseInt(document.getElementById('pickerPoints').value);
            const wrapped = document.getElementById('wrapped').checked;
            const reWrapped = document.getElementById('reWrapped').checked;
            const wrappedBy = wrapped ? document.getElementById('wrappedBy').value : '';
            const reWrappedBy = reWrapped ? document.getElementById('reWrappedBy').value : '';
            const calledSuit = document.getElementById('calledSuit').value;
            
            if (!picker || !partner || isNaN(points) || !calledSuit) {
                alert('Please select picker, partner, points, and called suit');
                return;
            }
            
            if (wrapped && !wrappedBy) {
                alert('Please select who wrapped the hand');
                return;
            }
            
            if (reWrapped && !reWrappedBy) {
                alert('Please select who re-wrapped the hand');
                return;
            }
            
            const handResult = calculateScores(picker, partner, points, wrapped, reWrapped, calledSuit, wrappedBy, reWrappedBy);
            hands.push(handResult);
            
            updatePlayerStats(handResult);
            updateScoreTable();
            updateStatsTable();
            clearHand();
            currentHand++;
        }

        function calculateScores(picker, partner, points, wrapped = false, reWrapped = false, calledSuit = '', wrappedBy = '', reWrappedBy = '') {
            const hand = {
                number: currentHand,
                picker: picker,
                partner: partner,
                points: points,
                wrapped: wrapped,
                reWrapped: reWrapped,
                wrappedBy: wrappedBy,
                reWrappedBy: reWrappedBy,
                calledSuit: calledSuit,
                scores: {}
            };
            
            const pickerTeamWon = points >= 61;
            const schneider = points >= 91 || points <= 30;
            const schwarz = points === 120 || points === 0;
            
            let basePoints = 1;
            if (schneider) basePoints = 2;
            if (schwarz) basePoints = 3;
            
            if (wrapped) basePoints *= 2;
            if (reWrapped) basePoints *= 2;
            
            players.forEach(player => {
                if (player === picker) {
                    hand.scores[player] = pickerTeamWon ? basePoints * 2 : -basePoints * 2;
                } else if (player === partner) {
                    hand.scores[player] = pickerTeamWon ? basePoints : -basePoints;
                } else {
                    hand.scores[player] = pickerTeamWon ? -basePoints : basePoints;
                }
            });
            
            let description = `${picker}+${partner} ${pickerTeamWon ? 'WON' : 'LOST'} (${points} pts, called ${calledSuit})`;
            if (schwarz) description += ' SCHWARZ';
            else if (schneider) description += ' SCHNEIDER';
            if (wrapped) description += ` WRAPPED by ${wrappedBy}`;
            if (reWrapped) description += ` RE-WRAPPED by ${reWrappedBy}`;
            
            hand.description = description;
            
            return hand;
        }

        function updateScoreTable() {
            const tbody = document.getElementById('scoreBody');
            
            const totals = {};
            players.forEach(p => totals[p] = 0);
            
            let html = '';
            
            hands.forEach(hand => {
                html += `<tr>
                    <td>${hand.number}</td>
                    ${players.map(p => {
                        totals[p] += hand.scores[p];
                        return `<td class="${hand.scores[p] > 0 ? 'positive' : 'negative'}">${hand.scores[p]}</td>`;
                    }).join('')}
                    <td style="font-size: 12px;">${hand.description}</td>
                </tr>`;
            });
            
            html += `<tr class="totals">
                <td><strong>TOTAL</strong></td>
                ${players.map(p => `<td class="${totals[p] > 0 ? 'positive' : 'negative'}"><strong>${totals[p]}</strong></td>`).join('')}
                <td></td>
            </tr>`;
            
            tbody.innerHTML = html;
        }

        function clearHand() {
            document.getElementById('picker').value = '';
            document.getElementById('partner').value = '';
            document.getElementById('pickerPoints').value = '';
            document.getElementById('wrapped').checked = false;
            document.getElementById('reWrapped').checked = false;
            document.getElementById('wrappedBy').value = '';
            document.getElementById('reWrappedBy').value = '';
            document.getElementById('calledSuit').value = '';
            updatePartnerOptions();
        }

        function newGame() {
            if (confirm('Start a new game? This will reset all scores.')) {
                hands = [];
                currentHand = 1;
                playerStats = {};
                document.getElementById('setup').classList.remove('hidden');
                document.getElementById('gameSection').classList.add('hidden');
                updateScoreTable();
                updateStatsTable();
            }
        }

        function exportGame() {
            if (hands.length === 0) {
                alert('No hands to export!');
                return;
            }
            
            let csv = 'Hand,';
            csv += players.join(',') + ',Details\n';
            
            const totals = {};
            players.forEach(p => totals[p] = 0);
            
            hands.forEach(hand => {
                csv += `${hand.number},`;
                csv += players.map(p => {
                    totals[p] += hand.scores[p];
                    return hand.scores[p];
                }).join(',');
                csv += `,"${hand.description}"\n`;
            });
            
            csv += 'TOTAL,';
            csv += players.map(p => totals[p]).join(',') + ',\n';
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sheepshead_scores_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });

        document.getElementById('pickerPoints').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scoreHand();
            }
        });
        
        function generateSessionId() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
            return `session_${dateStr}_${timeStr}`;
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'history') {
                loadHistoricalData();
            } else if (tabName === 'stats') {
                calculateAllTimeStats();
            }
        }
        
        function saveSession() {
            if (hands.length === 0) {
                alert('No hands to save!');
                return;
            }
            
            const sessionData = {
                id: currentSessionId,
                date: new Date().toISOString().split('T')[0],
                startTime: gameStartTime,
                endTime: new Date().toISOString(),
                players: [...players],
                hands: [...hands],
                finalScores: {},
                totalHands: hands.length
            };
            
            // Calculate final scores
            players.forEach(player => {
                sessionData.finalScores[player] = hands.reduce((total, hand) => {
                    return total + (hand.scores[player] || 0);
                }, 0);
            });
            
            // Save to localStorage
            const existingSessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const existingIndex = existingSessions.findIndex(s => s.id === currentSessionId);
            
            if (existingIndex >= 0) {
                existingSessions[existingIndex] = sessionData;
            } else {
                existingSessions.push(sessionData);
            }
            
            localStorage.setItem('sheepsheadSessions', JSON.stringify(existingSessions));
            
            // Update player profiles
            updatePlayerProfiles(sessionData);
            
            alert('Session saved successfully!');
        }
        
        function updatePlayerProfiles(sessionData) {
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            
            sessionData.players.forEach(player => {
                if (!profiles[player]) {
                    profiles[player] = {
                        allTimeRecord: {wins: 0, losses: 0},
                        totalSessions: 0,
                        totalHands: 0,
                        allTimeScore: 0,
                        timesPickedTotal: 0,
                        timesPartnerTotal: 0,
                        lastPlayed: null,
                        sessions: []
                    };
                }
                
                const profile = profiles[player];
                const playerStats = calculatePlayerStatsForSession(sessionData, player);
                
                profile.allTimeRecord.wins += playerStats.wins;
                profile.allTimeRecord.losses += playerStats.losses;
                profile.totalSessions += 1;
                profile.totalHands += playerStats.handsPlayed;
                profile.allTimeScore += sessionData.finalScores[player];
                profile.timesPickedTotal += playerStats.timesPicked;
                profile.timesPartnerTotal += playerStats.timesPartner;
                profile.lastPlayed = sessionData.date;
                
                if (!profile.sessions.includes(sessionData.id)) {
                    profile.sessions.push(sessionData.id);
                }
            });
            
            localStorage.setItem('sheepsheadProfiles', JSON.stringify(profiles));
        }
        
        function calculatePlayerStatsForSession(sessionData, player) {
            const stats = {
                wins: 0,
                losses: 0,
                timesPicked: 0,
                timesPartner: 0,
                handsPlayed: sessionData.hands.length
            };
            
            sessionData.hands.forEach(hand => {
                const pickerTeamWon = hand.points >= 61;
                
                if (hand.picker === player) {
                    stats.timesPicked++;
                    if (pickerTeamWon) stats.wins++;
                    else stats.losses++;
                } else if (hand.partner === player) {
                    stats.timesPartner++;
                    if (pickerTeamWon) stats.wins++;
                    else stats.losses++;
                } else {
                    if (!pickerTeamWon) stats.wins++;
                    else stats.losses++;
                }
            });
            
            return stats;
        }
        
        function loadHistoricalData() {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const sessionsList = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                sessionsList.innerHTML = '<p>No saved sessions found.</p>';
                return;
            }
            
            sessions.sort((a, b) => new Date(b.endTime) - new Date(a.endTime));
            
            let html = '';
            sessions.forEach(session => {
                const date = new Date(session.endTime).toLocaleDateString();
                const time = new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const winner = Object.entries(session.finalScores).reduce((a, b) => session.finalScores[a[0]] > session.finalScores[b[0]] ? a : b);
                
                html += `
                    <div class="session-item" onclick="viewSessionDetail('${session.id}')">
                        <div class="session-meta">
                            <strong>${date} at ${time}</strong>
                            <span>${session.totalHands} hands</span>
                        </div>
                        <div class="session-players">
                            Players: ${session.players.join(', ')}
                        </div>
                        <div style="font-size: 14px; color: #4CAF50; margin-top: 5px;">
                            Winner: ${winner[0]} (${winner[1]} points)
                        </div>
                    </div>
                `;
            });
            
            sessionsList.innerHTML = html;
        }
        
        function viewSessionDetail(sessionId) {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);
            
            if (!session) return;
            
            const modal = document.getElementById('sessionModal');
            const detail = document.getElementById('sessionDetail');
            
            const date = new Date(session.endTime).toLocaleDateString();
            const startTime = new Date(session.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const endTime = new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let html = `
                <h2>Session Details - ${date}</h2>
                <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Total Hands:</strong> ${session.totalHands}</p>
                
                <h3>Final Scores</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            ${session.players.map(p => `<th>${p}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            ${session.players.map(p => {
                                const score = session.finalScores[p];
                                return `<td class="${score > 0 ? 'positive' : 'negative'}"><strong>${score}</strong></td>`;
                            }).join('')}
                        </tr>
                    </tbody>
                </table>
                
                <h3>Hand History</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Hand</th>
                            ${session.players.map(p => `<th>${p}</th>`).join('')}
                            <th>Called Suit</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            session.hands.forEach(hand => {
                html += `
                    <tr>
                        <td>${hand.number}</td>
                        ${session.players.map(p => {
                            const score = hand.scores[p] || 0;
                            return `<td class="${score > 0 ? 'positive' : 'negative'}">${score}</td>`;
                        }).join('')}
                        <td>${hand.calledSuit || 'N/A'}</td>
                        <td style="font-size: 12px;">${hand.description}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <button onclick="deleteSession('${sessionId}')">Delete Session</button>
                    <button onclick="exportSession('${sessionId}')">Export Session</button>
                </div>
            `;
            
            detail.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closeSessionModal() {
            document.getElementById('sessionModal').style.display = 'none';
        }
        
        function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;
            
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const updatedSessions = sessions.filter(s => s.id !== sessionId);
            localStorage.setItem('sheepsheadSessions', JSON.stringify(updatedSessions));
            
            closeSessionModal();
            loadHistoricalData();
            alert('Session deleted successfully!');
        }
        
        function calculateAllTimeStats() {
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const statsDiv = document.getElementById('allTimeStats');
            
            if (Object.keys(profiles).length === 0) {
                statsDiv.innerHTML = '<p>No player data available. Play some games first!</p>';
                return;
            }
            
            const playerData = Object.entries(profiles).map(([name, profile]) => ({
                name,
                ...profile,
                winPercentage: profile.totalHands > 0 ? ((profile.allTimeRecord.wins / profile.totalHands) * 100).toFixed(1) : 0,
                avgScorePerHand: profile.totalHands > 0 ? (profile.allTimeScore / profile.totalHands).toFixed(2) : 0
            })).sort((a, b) => b.allTimeScore - a.allTimeScore);
            
            // Calculate suit calling statistics
            const suitStats = calculateSuitCallingStats(sessions);
            
            let html = `
                <h3>Player Rankings</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Total Score</th>
                            <th>Sessions</th>
                            <th>Record</th>
                            <th>Win %</th>
                            <th>Avg/Hand</th>
                            <th>Times Picked</th>
                            <th>Times Partner</th>
                            <th>Last Played</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            playerData.forEach((player, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><strong>${player.name}</strong></td>
                        <td class="${player.allTimeScore > 0 ? 'positive' : 'negative'}"><strong>${player.allTimeScore}</strong></td>
                        <td>${player.totalSessions}</td>
                        <td>${player.allTimeRecord.wins}-${player.allTimeRecord.losses}</td>
                        <td>${player.winPercentage}%</td>
                        <td class="${parseFloat(player.avgScorePerHand) > 0 ? 'positive' : 'negative'}">${player.avgScorePerHand}</td>
                        <td>${player.timesPickedTotal}</td>
                        <td>${player.timesPartnerTotal}</td>
                        <td>${player.lastPlayed || 'Never'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3 style="margin-top: 30px;">Called Suit Statistics</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div class="scoreboard">
                        <h4>Overall Suit Performance</h4>
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Suit</th>
                                    <th>Times Called</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.entries(suitStats.overall).forEach(([suit, stats]) => {
                const winRate = stats.total > 0 ? ((stats.wins / stats.total) * 100).toFixed(1) : 0;
                html += `
                    <tr>
                        <td><strong>${suit}</strong></td>
                        <td>${stats.total}</td>
                        <td class="${parseFloat(winRate) > 50 ? 'positive' : 'negative'}">${winRate}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="scoreboard">
                        <h4>Player Suit Preferences</h4>
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Favorite Suit</th>
                                    <th>Success Rate</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.entries(suitStats.byPlayer).forEach(([player, suits]) => {
                const favoriteData = Object.entries(suits)
                    .reduce((max, [suit, stats]) => stats.total > max.total ? {suit, ...stats} : max, {suit: 'None', total: 0, wins: 0});
                const successRate = favoriteData.total > 0 ? ((favoriteData.wins / favoriteData.total) * 100).toFixed(1) : 0;
                
                html += `
                    <tr>
                        <td><strong>${player}</strong></td>
                        <td>${favoriteData.suit} (${favoriteData.total}x)</td>
                        <td class="${parseFloat(successRate) > 50 ? 'positive' : 'negative'}">${successRate}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="scoreboard">
                        <h4>Wrap/Re-wrap Statistics</h4>
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Times Wrapped</th>
                                    <th>Wrap Success</th>
                                    <th>Times Re-wrapped</th>
                                    <th>Re-wrap Success</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            const wrapStats = calculateWrapStats(sessions);
            Object.entries(wrapStats).forEach(([player, stats]) => {
                const wrapSuccess = stats.wraps > 0 ? ((stats.wrapWins / stats.wraps) * 100).toFixed(1) : 0;
                const rewrapSuccess = stats.rewraps > 0 ? ((stats.rewrapWins / stats.rewraps) * 100).toFixed(1) : 0;
                
                html += `
                    <tr>
                        <td><strong>${player}</strong></td>
                        <td>${stats.wraps}</td>
                        <td class="${parseFloat(wrapSuccess) > 50 ? 'positive' : 'negative'}">${wrapSuccess}%</td>
                        <td>${stats.rewraps}</td>
                        <td class="${parseFloat(rewrapSuccess) > 50 ? 'positive' : 'negative'}">${rewrapSuccess}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            statsDiv.innerHTML = html;
        }
        
        function calculateWrapStats(sessions) {
            const wrapStats = {};
            
            // Initialize all players
            sessions.forEach(session => {
                session.players.forEach(player => {
                    if (!wrapStats[player]) {
                        wrapStats[player] = {
                            wraps: 0,
                            wrapWins: 0,
                            rewraps: 0,
                            rewrapWins: 0
                        };
                    }
                });
            });
            
            sessions.forEach(session => {
                session.hands.forEach(hand => {
                    const won = hand.points >= 61;
                    
                    if (hand.wrapped && hand.wrappedBy) {
                        const wrapper = hand.wrappedBy;
                        if (wrapStats[wrapper]) {
                            wrapStats[wrapper].wraps++;
                            if (won) wrapStats[wrapper].wrapWins++;
                        }
                    }
                    
                    if (hand.reWrapped && hand.reWrappedBy) {
                        const rewrapper = hand.reWrappedBy;
                        if (wrapStats[rewrapper]) {
                            wrapStats[rewrapper].rewraps++;
                            if (won) wrapStats[rewrapper].rewrapWins++;
                        }
                    }
                });
            });
            
            return wrapStats;
        }
        
        function calculateSuitCallingStats(sessions) {
            const overall = {
                'Hearts': {wins: 0, total: 0},
                'Spades': {wins: 0, total: 0},
                'Clubs': {wins: 0, total: 0}
            };
            
            const byPlayer = {};
            
            sessions.forEach(session => {
                session.hands.forEach(hand => {
                    if (hand.calledSuit) {
                        const suit = hand.calledSuit;
                        const won = hand.points >= 61;
                        
                        // Overall stats
                        if (!overall[suit]) overall[suit] = {wins: 0, total: 0};
                        overall[suit].total++;
                        if (won) overall[suit].wins++;
                        
                        // Player stats
                        const picker = hand.picker;
                        if (!byPlayer[picker]) byPlayer[picker] = {};
                        if (!byPlayer[picker][suit]) byPlayer[picker][suit] = {wins: 0, total: 0};
                        byPlayer[picker][suit].total++;
                        if (won) byPlayer[picker][suit].wins++;
                    }
                });
            });
            
            return {overall, byPlayer};
        }
        
        function exportAllData() {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            
            const data = {
                sessions,
                profiles,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sheepshead_all_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function exportSession(sessionId) {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);
            
            if (!session) return;
            
            const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sheepshead_session_${session.date}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function importData() {
            document.getElementById('importFile').click();
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.sessions && Array.isArray(data.sessions)) {
                        const existingSessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
                        const merged = [...existingSessions];
                        
                        data.sessions.forEach(newSession => {
                            const existingIndex = merged.findIndex(s => s.id === newSession.id);
                            if (existingIndex >= 0) {
                                merged[existingIndex] = newSession;
                            } else {
                                merged.push(newSession);
                            }
                        });
                        
                        localStorage.setItem('sheepsheadSessions', JSON.stringify(merged));
                    }
                    
                    if (data.profiles && typeof data.profiles === 'object') {
                        const existingProfiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
                        const mergedProfiles = { ...existingProfiles, ...data.profiles };
                        localStorage.setItem('sheepsheadProfiles', JSON.stringify(mergedProfiles));
                    }
                    
                    alert('Data imported successfully!');
                    loadHistoricalData();
                    calculateAllTimeStats();
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('sessionModal');
            if (event.target === modal) {
                closeSessionModal();
            }
        }
        
        function initializePlayerStats() {
            playerStats = {};
            players.forEach(player => {
                playerStats[player] = {
                    wins: 0,
                    losses: 0,
                    timesPicked: 0,
                    timesPartner: 0,
                    totalScore: 0,
                    handsPlayed: 0
                };
            });
        }
        
        function updatePlayerStats(hand) {
            const pickerTeamWon = hand.points >= 61;
            
            players.forEach(player => {
                const stats = playerStats[player];
                stats.handsPlayed++;
                stats.totalScore += hand.scores[player];
                
                if (player === hand.picker) {
                    stats.timesPicked++;
                    if (pickerTeamWon) stats.wins++;
                    else stats.losses++;
                } else if (player === hand.partner) {
                    stats.timesPartner++;
                    if (pickerTeamWon) stats.wins++;
                    else stats.losses++;
                } else {
                    if (!pickerTeamWon) stats.wins++;
                    else stats.losses++;
                }
            });
        }
        
        function updateStatsTable() {
            const tbody = document.getElementById('statsBody');
            
            let html = '';
            players.forEach(player => {
                const stats = playerStats[player];
                const winPercentage = stats.handsPlayed > 0 ? 
                    ((stats.wins / stats.handsPlayed) * 100).toFixed(1) : '0.0';
                const avgScore = stats.handsPlayed > 0 ? 
                    (stats.totalScore / stats.handsPlayed).toFixed(1) : '0.0';
                
                html += `<tr>
                    <td><strong>${player}</strong></td>
                    <td>${stats.wins}-${stats.losses}</td>
                    <td>${winPercentage}%</td>
                    <td>${stats.timesPicked}</td>
                    <td>${stats.timesPartner}</td>
                    <td class="${parseFloat(avgScore) > 0 ? 'positive' : 'negative'}">${avgScore}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }
    </script>
</body>
</html>