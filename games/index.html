<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheepshead Score Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c5530, #1a4d1a);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .setup-section, .game-section {
            margin-bottom: 30px;
        }

        .setup-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, button, select {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        input {
            width: 100%;
            max-width: 300px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .player-tag {
            background: #2196F3;
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-player {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        .scoreboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .score-table th,
        .score-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .score-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        
        .doublers-row {
            background: rgba(255, 215, 0, 0.1) !important;
            border-top: 2px solid rgba(255, 215, 0, 0.3) !important;
        }
        
        .doublers-row td {
            color: #FFD700;
            font-weight: bold;
        }

        .score-input {
            width: 80px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .hand-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .hand-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-group h4 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }
        
        .form-row label {
            margin-bottom: 0;
            min-width: 80px;
            font-size: 14px;
        }
        
        .form-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .form-row select {
            flex: 1;
            min-width: 120px;
        }
        
        .wrap-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .wrap-controls input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .wrap-controls label {
            margin: 0;
            font-size: 14px;
        }
        
        .wrap-by {
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .wrap-by label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }
        
        .wrap-by select {
            padding: 5px 8px;
            font-size: 12px;
            min-width: 100px;
        }

        .picker-partner {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .hidden {
            display: none;
        }

        .totals {
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #f44336;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .nav-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #fff;
            border-bottom-color: #4CAF50;
        }

        .nav-tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .session-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .session-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .session-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .session-players {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c5530, #1a4d1a);
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .settlement-section {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settlement-section h3 {
            color: #FFC107;
            margin-bottom: 15px;
        }
        
        .session-marker {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #FFC107;
            color: #FFC107;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .session-totals {
            background: rgba(255, 193, 7, 0.15);
            font-weight: bold;
        }
        
        .debt {
            color: #f44336;
            font-weight: bold;
        }
        
        .credit {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .preset-players {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .preset-players h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 16px;
        }
        
        .player-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .player-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .player-checkbox:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .player-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .player-checkbox label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
        
        .dealer-sitting-controls {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .dealer-sitting-controls h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 16px;
        }
        
        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-item label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .sitting-out {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .dealer-indicator {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .hand-section h3 {
            margin-bottom: 20px;
        }
        
        .doubler-indicator {
            color: #FFC107;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .hand-controls {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐑 Sheepshead Score Tracker</h1>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('current')">Current Game</button>
            <button class="nav-tab" onclick="showTab('history')">Game History</button>
            <button class="nav-tab" onclick="showTab('stats')">All-Time Stats</button>
        </div>

        <div id="currentTab" class="tab-content active">
        <div id="setup" class="setup-section">
            <h2>Game Setup</h2>
            
            <div class="preset-players">
                <h3>Select Regular Players</h3>
                <div class="player-checkboxes" id="presetPlayers">
                    <div class="player-checkbox">
                        <input type="checkbox" id="duane" value="Duane Haas">
                        <label for="duane">Duane Haas</label>
                    </div>
                    <div class="player-checkbox">
                        <input type="checkbox" id="nate" value="Nate Miller">
                        <label for="nate">Nate Miller</label>
                    </div>
                    <div class="player-checkbox">
                        <input type="checkbox" id="adam" value="Adam Arndt">
                        <label for="adam">Adam Arndt</label>
                    </div>
                    <div class="player-checkbox">
                        <input type="checkbox" id="jim" value="Jim Remm">
                        <label for="jim">Jim Remm</label>
                    </div>
                    <div class="player-checkbox">
                        <input type="checkbox" id="rick" value="Rick Lopez">
                        <label for="rick">Rick Lopez</label>
                    </div>
                    <div class="player-checkbox">
                        <input type="checkbox" id="jeff" value="Jeff LaValle">
                        <label for="jeff">Jeff LaValle</label>
                    </div>
                    <div class="player-checkbox">
                        <input type="checkbox" id="todd" value="Todd Sobotka">
                        <label for="todd">Todd Sobotka</label>
                    </div>
                </div>
                <div class="input-group">
                    <label for="playerName">Add Custom Player:</label>
                    <input type="text" id="playerName" placeholder="Enter player name">
                    <button onclick="addCustomPlayer()">Add Player</button>
                </div>
            </div>
            
            <div class="dealer-sitting-controls" id="dealerSittingControls" style="display: none;">
                <h3>Game Management</h3>
                <div class="control-row">
                    <div class="control-item" id="sittingOutControl" style="display: none;">
                        <label for="sittingOut">Sitting Out:</label>
                        <select id="sittingOut">
                            <option value="">No one sitting out</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="players-list" id="playersList"></div>
            
            <button onclick="startGame()" id="startBtn" disabled>Start Game (Need 5+ Players)</button>
        </div>

        <div id="gameSection" class="game-section hidden">
            <div class="hand-section">
                <h3 id="currentHandTitle">Current Hand</h3>
                <div class="hand-controls">
                    <div class="control-group">
                        <h4>Basic Hand Info</h4>
                        
                        <div class="form-row">
                            <label for="handDealer">Dealer:</label>
                            <select id="handDealer" onchange="updatePickerPartnerOptions()">
                                <option value="">Select Dealer First</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="picker">Picker:</label>
                            <select id="picker" onchange="updatePickerPartnerOptions()">
                                <option value="">Select Picker</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="partner">Partner:</label>
                            <select id="partner">
                                <option value="">Select Partner</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="calledSuit">Called:</label>
                            <select id="calledSuit">
                                <option value="">Select Called Suit</option>
                                <option value="Hearts">Hearts</option>
                                <option value="Spades">Spades</option>
                                <option value="Clubs">Clubs (non-trump)</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label for="pickerPoints">Points:</label>
                            <input type="number" id="pickerPoints" min="0" max="120" placeholder="0-120">
                        </div>
                        
                        <div class="form-row">
                            <label>
                                <input type="checkbox" id="isDoubler" onchange="updateHandTypeOptions()" style="width: auto; margin-right: 8px;">
                                Doubler (Nobody picked)
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Wrap Status</h4>
                        
                        <div class="wrap-controls">
                            <input type="checkbox" id="wrapped">
                            <label for="wrapped">Wrapped (doubled)</label>
                        </div>
                        <div class="wrap-by">
                            <label for="wrappedBy">By:</label>
                            <select id="wrappedBy">
                                <option value="">Who wrapped?</option>
                            </select>
                        </div>
                        
                        <div class="wrap-controls">
                            <input type="checkbox" id="reWrapped">
                            <label for="reWrapped">Re-wrapped (re-doubled)</label>
                        </div>
                        <div class="wrap-by">
                            <label for="reWrappedBy">By:</label>
                            <select id="reWrappedBy">
                                <option value="">Who re-wrapped?</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button onclick="scoreHand()">Score Hand</button>
                <button onclick="clearHand()">Clear Hand</button>
            </div>

            <div class="settlement-section" id="settlementSection" style="display: none;">
                <h3>💰 Settlement Summary</h3>
                <p>Total debt/winnings across all 5-hand sessions:</p>
                <table class="score-table" id="settlementTable">
                    <thead>
                        <tr id="settlementHeader">
                            <th>Player</th>
                            <th>Total Owed/Won</th>
                        </tr>
                    </thead>
                    <tbody id="settlementBody">
                    </tbody>
                </table>
            </div>

            <div class="scoreboard">
                <h3>Current Session Scoreboard</h3>
                <div id="sessionInfo" style="text-align: center; margin-bottom: 15px; color: #4CAF50; font-weight: bold;"></div>
                <table class="score-table" id="scoreTable">
                    <thead>
                        <tr>
                            <th>Hand</th>
                        </tr>
                    </thead>
                    <tbody id="scoreBody">
                    </tbody>
                </table>
            </div>

            <div class="scoreboard">
                <h3>Player Statistics</h3>
                <table class="score-table" id="statsTable">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Record</th>
                            <th>Win %</th>
                            <th>Times Picked</th>
                            <th>Times Partner</th>
                            <th>Doublers Won</th>
                            <th>Avg Score/Hand</th>
                        </tr>
                    </thead>
                    <tbody id="statsBody">
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="saveSession()">Save Session</button>
                <button onclick="newGame()">New Game</button>
                <button onclick="exportGame()">Export Current Game</button>
            </div>
        </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="setup-section">
                <h2>Game History</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="loadHistoricalData()">Refresh</button>
                    <button onclick="exportAllData()">Export All Data</button>
                    <button onclick="importData()">Import Data</button>
                    <button onclick="debugStorage()">Debug Storage</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                </div>
                <div id="sessionsList"></div>
            </div>
        </div>

        <div id="statsTab" class="tab-content">
            <div class="setup-section">
                <h2>All-Time Player Statistics</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="calculateAllTimeStats()">Refresh Stats</button>
                    <button onclick="debugStorage()">Debug Storage</button>
                </div>
                <div id="allTimeStats"></div>
            </div>
        </div>

        <!-- Session Detail Modal -->
        <div id="sessionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSessionModal()">&times;</span>
                <div id="sessionDetail"></div>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let allPlayers = []; // All selected players including sitting out
        let hands = [];
        let currentHand = 1;
        let playerStats = {};
        let currentSessionId = null;
        let gameStartTime = null;
        let currentHandDealer = null;
        let sittingOut = null;
        let fiveHandSessions = []; // Track each 5-hand session
        let currentSessionNumber = 1;
        let totalPlayerDebts = {}; // Running total of what each player owes
        let nextHandIsDoubled = false; // Whether the next hand should be doubled
        let currentHandMultiplier = 1; // Current hand scoring multiplier (always 2 if doubled)

        function addCustomPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (name && allPlayers.length < 8 && !allPlayers.some(p => p.name === name)) {
                // Add as checkbox
                const presetContainer = document.getElementById('presetPlayers');
                const playerId = name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/gi, '');
                
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'player-checkbox';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="${playerId}" value="${name}" checked>
                    <label for="${playerId}">${name}</label>
                `;
                presetContainer.appendChild(checkboxDiv);
                
                // Add event listener
                checkboxDiv.querySelector('input').addEventListener('change', updateSelectedPlayers);
                
                nameInput.value = '';
                updateSelectedPlayers();
            } else if (allPlayers.length >= 8) {
                alert('Maximum 8 players allowed!');
            }
        }

        function removePlayer(name) {
            // Find and uncheck the corresponding checkbox
            const checkboxes = document.querySelectorAll('#presetPlayers input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === name) {
                    checkbox.checked = false;
                }
            });
            updateSelectedPlayers();
        }

        function updatePlayersList() {
            const list = document.getElementById('playersList');
            list.innerHTML = allPlayers.map(player => {
                let classes = 'player-tag';
                let statusText = '';
                
                // No dealer indicator in setup - dealer is selected per hand
                if (player.name === sittingOut) {
                    classes += ' sitting-out';
                    statusText = ' (Sitting Out)';
                }
                
                return `<div class="${classes}">
                    ${player.name}${statusText}
                    <button class="remove-player" onclick="removePlayer('${player.name}')">×</button>
                </div>`;
            }).join('');
        }

        function updateStartButton() {
            const startBtn = document.getElementById('startBtn');
            const activePlayers = players.length; // players array only contains active (non-sitting) players
            
            if (activePlayers < 5) {
                startBtn.disabled = true;
                startBtn.textContent = `Start Game (Need ${5 - activePlayers} more players)`;
            } else {
                startBtn.disabled = false;
                startBtn.textContent = `Start Game (${activePlayers} players)`;
            }
        }

        function startGame() {
            if (players.length < 5) return;
            
            gameStartTime = new Date().toISOString();
            currentSessionId = generateSessionId();
            initializePlayerStats();
            initializeSessionTracking();
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            setupGameInterface();
            updateCurrentHandTitle();
            console.log('Game started with players:', players);
        }

        function setupGameInterface() {
            console.log('Setting up game interface with players:', players);
            const picker = document.getElementById('picker');
            const partner = document.getElementById('partner');
            const wrappedBy = document.getElementById('wrappedBy');
            const reWrappedBy = document.getElementById('reWrappedBy');
            const handDealer = document.getElementById('handDealer');
            
            const playerOptions = players.map(p => `<option value="${p}">${p}</option>`).join('');
            console.log('Player options HTML:', playerOptions);
            
            picker.innerHTML = '<option value="">Select Picker</option>' + playerOptions;
            wrappedBy.innerHTML = '<option value="">Who wrapped?</option>' + playerOptions;
            reWrappedBy.innerHTML = '<option value="">Who re-wrapped?</option>' + playerOptions;
            handDealer.innerHTML = '<option value="">Select Dealer First</option>' + playerOptions;
            
            setupScoreTable();
        }

        function updatePartnerOptions() {
            const picker = document.getElementById('picker').value;
            const partner = document.getElementById('partner');
            
            partner.innerHTML = '<option value="">Select Partner</option>' +
                players.filter(p => p !== picker)
                    .map(p => `<option value="${p}">${p}</option>`).join('');
        }
        
        function updatePickerPartnerOptions() {
            const dealer = document.getElementById('handDealer').value;
            const picker = document.getElementById('picker');
            const partner = document.getElementById('partner');
            
            // Store current values before updating dropdowns
            const currentPickerValue = picker.value;
            const currentPartnerValue = partner.value;
            
            // Only exclude dealer if there are more than 5 players
            const shouldExcludeDealer = players.length > 5;
            
            // With 5 players, dealer can be picker/partner, so no need to rebuild dropdowns
            if (!shouldExcludeDealer) {
                // Just update partner dropdown to exclude current picker
                const actualPickerValue = picker.value;
                if (actualPickerValue) {
                    let availableForPartner = players.filter(p => p !== actualPickerValue);
                    partner.innerHTML = '<option value="">Select Partner</option>' + 
                        availableForPartner.map(p => `<option value="${p}">${p}</option>`).join('');
                    
                    // Restore partner value if it's still valid
                    if (availableForPartner.includes(currentPartnerValue)) {
                        partner.value = currentPartnerValue;
                    }
                }
                return;
            }
            
            // With 6+ players, need to exclude dealer from picker/partner options
            
            // Update picker dropdown
            if (dealer) {
                let availableForPicker = players.filter(p => p !== dealer);
                picker.innerHTML = '<option value="">Select Picker</option>' + 
                    availableForPicker.map(p => `<option value="${p}">${p}</option>`).join('');
                
                // Restore picker value if it's still valid
                if (availableForPicker.includes(currentPickerValue)) {
                    picker.value = currentPickerValue;
                }
            } else {
                // Show "Select Dealer First" when we have 6+ players and no dealer selected
                picker.innerHTML = '<option value="">Select Dealer First</option>';
            }
            
            // Update partner dropdown - exclude current picker and dealer
            const actualPickerValue = picker.value;
            if (dealer) {
                let availableForPartner = players.filter(p => p !== actualPickerValue && p !== dealer);
                partner.innerHTML = '<option value="">Select Partner</option>' + 
                    availableForPartner.map(p => `<option value="${p}">${p}</option>`).join('');
                
                // Restore partner value if it's still valid
                if (availableForPartner.includes(currentPartnerValue)) {
                    partner.value = currentPartnerValue;
                }
            } else {
                // Show "Select Dealer First" when we have 6+ players and no dealer selected
                partner.innerHTML = '<option value="">Select Dealer First</option>';
            }
        }

        function setupScoreTable() {
            const table = document.getElementById('scoreTable');
            const thead = table.querySelector('thead tr');
            const tbody = document.getElementById('scoreBody');
            
            thead.innerHTML = '<th>Hand</th>' + 
                players.map(p => `<th>${p}</th>`).join('') +
                '<th>Details</th>';
            
            updateScoreTable();
        }

        function scoreHand() {
            const isDoubler = document.getElementById('isDoubler').checked;
            
            // Determine if this hand is doubled (from previous doubler)
            currentHandMultiplier = nextHandIsDoubled ? 2 : 1;
            
            if (isDoubler) {
                handleDoubler();
                return;
            }
            
            // Normal hand logic
            const picker = document.getElementById('picker').value;
            const partner = document.getElementById('partner').value;
            const points = parseInt(document.getElementById('pickerPoints').value);
            const wrapped = document.getElementById('wrapped').checked;
            const reWrapped = document.getElementById('reWrapped').checked;
            const wrappedBy = wrapped ? document.getElementById('wrappedBy').value : '';
            const reWrappedBy = reWrapped ? document.getElementById('reWrappedBy').value : '';
            const calledSuit = document.getElementById('calledSuit').value;
            const handDealer = document.getElementById('handDealer').value;
            
            if (!handDealer && players.length > 5) {
                alert('Please select the dealer first');
                return;
            }
            
            console.log('Validation check - picker:', picker, 'partner:', partner, 'points:', points, 'calledSuit:', calledSuit, 'handDealer:', handDealer);
            
            if (!picker) {
                alert('Please select a picker');
                return;
            }
            if (!partner) {
                alert('Please select a partner');
                return;
            }
            if (isNaN(points)) {
                alert('Please enter valid points');
                return;
            }
            if (!calledSuit) {
                alert('Please select the called suit');
                return;
            }
            if (!handDealer) {
                alert('Please select the dealer');
                return;
            }
            
            if (wrapped && !wrappedBy) {
                alert('Please select who wrapped the hand');
                return;
            }
            
            if (reWrapped && !reWrappedBy) {
                alert('Please select who re-wrapped the hand');
                return;
            }
            
            const handResult = calculateScores(picker, partner, points, wrapped, reWrapped, calledSuit, wrappedBy, reWrappedBy, 'normal', currentHandMultiplier, handDealer);
            hands.push(handResult);
            
            updatePlayerStats(handResult);
            updateScoreTable();
            updateStatsTable();
            
            // Reset the doubler flag after using it
            nextHandIsDoubled = false;
            
            // Check if we've completed a 5-hand session
            if (currentHand % 5 === 0) {
                completeSession();
            }
            
            clearHand();
            currentHand++;
        }

        function calculateScores(picker, partner, points, wrapped = false, reWrapped = false, calledSuit = '', wrappedBy = '', reWrappedBy = '', handType = 'normal', multiplier = 1, dealer = '') {
            const hand = {
                number: currentHand,
                picker: picker,
                partner: partner,
                points: points,
                wrapped: wrapped,
                reWrapped: reWrapped,
                wrappedBy: wrappedBy,
                reWrappedBy: reWrappedBy,
                calledSuit: calledSuit,
                handType: handType,
                multiplier: multiplier,
                dealer: dealer,
                scores: {}
            };
            
            const pickerTeamWon = points >= 61;
            const schneider = points >= 91 || points <= 30;
            const schwarz = points === 120 || points === 0;
            
            let basePoints = 1;
            if (schneider) basePoints = 2;
            if (schwarz) basePoints = 3;
            
            if (wrapped) basePoints *= 2;
            if (reWrapped) basePoints *= 2;
            
            players.forEach(player => {
                let score = 0;
                if (player === picker) {
                    score = pickerTeamWon ? basePoints * 2 : -basePoints * 2;
                } else if (player === partner) {
                    score = pickerTeamWon ? basePoints : -basePoints;
                } else {
                    score = pickerTeamWon ? -basePoints : basePoints;
                }
                
                // Apply doubler multiplier
                hand.scores[player] = score * multiplier;
            });
            
            let description = `${picker}+${partner} ${pickerTeamWon ? 'WON' : 'LOST'} (${points} pts, called ${calledSuit})`;
            if (schwarz) description += ' NO TRICK';
            else if (schneider) description += ' SCHNEIDER';
            if (wrapped) description += ` WRAPPED by ${wrappedBy}`;
            if (reWrapped) description += ` RE-WRAPPED by ${reWrappedBy}`;
            if (multiplier > 1) description += ` DOUBLER x${multiplier}`;
            
            hand.description = description;
            
            return hand;
        }

        function updateScoreTable() {
            const tbody = document.getElementById('scoreBody');
            const sessionInfo = document.getElementById('sessionInfo');
            
            // Update session info
            const handsInCurrentSession = ((currentHand - 1) % 5) + 1;
            const handsRemaining = 5 - ((currentHand - 1) % 5);
            const doublerInfo = nextHandIsDoubled ? ` | NEXT HAND DOUBLED` : (currentHandMultiplier > 1 ? ` | THIS HAND DOUBLED` : '');
            sessionInfo.innerHTML = `Session ${currentSessionNumber} - Hand ${handsInCurrentSession} of 5 (${handsRemaining - 1} hands remaining)${doublerInfo}`;
            
            // Update current hand title
            updateCurrentHandTitle();
            
            const totals = {};
            const doublersWon = {};
            players.forEach(p => {
                totals[p] = 0;
                doublersWon[p] = 0;
            });
            
            let html = '';
            
            // Get hands for current session only
            const sessionStartHand = (currentSessionNumber - 1) * 5 + 1;
            const currentSessionHands = hands.filter(h => h.number >= sessionStartHand);
            
            currentSessionHands.forEach(hand => {
                // Track doublers won for this session
                if (hand.multiplier > 1 && hand.points >= 61) {
                    doublersWon[hand.picker]++;
                    doublersWon[hand.partner]++;
                }
                
                html += `<tr>
                    <td>${hand.number}</td>
                    ${players.map(p => {
                        totals[p] += hand.scores[p];
                        return `<td class="${hand.scores[p] > 0 ? 'positive' : 'negative'}">$${hand.scores[p]}</td>`;
                    }).join('')}
                    <td style="font-size: 12px;">${hand.description}</td>
                </tr>`;
            });
            
            html += `<tr class="totals">
                <td><strong>SESSION TOTAL</strong></td>
                ${players.map(p => `<td class="${totals[p] > 0 ? 'positive' : 'negative'}"><strong>$${totals[p]}</strong></td>`).join('')}
                <td></td>
            </tr>`;
            
            html += `<tr class="doublers-row">
                <td><strong>DOUBLERS WON</strong></td>
                ${players.map(p => `<td><strong>${doublersWon[p]}</strong></td>`).join('')}
                <td></td>
            </tr>`;
            
            // Add previous sessions summary
            if (fiveHandSessions.length > 0) {
                html += `<tr><td colspan="${players.length + 2}" class="session-marker">Previous Sessions</td></tr>`;
                
                fiveHandSessions.forEach((session, index) => {
                    html += `<tr class="session-totals">
                        <td><strong>Session ${index + 1}</strong></td>
                        ${players.map(p => {
                            const amount = session.totals[p] || 0;
                            return `<td class="${amount > 0 ? 'positive' : 'negative'}"><strong>$${amount}</strong></td>`;
                        }).join('')}
                        <td><em>Settled</em></td>
                    </tr>`;
                });
            }
            
            tbody.innerHTML = html;
        }
        
        function updateHandTypeOptions() {
            const isDoubler = document.getElementById('isDoubler').checked;
            const basicHandInfo = document.querySelector('.control-group:has(#picker)');
            const wrapSection = document.querySelector('.control-group:has(#wrapped)');
            
            if (isDoubler) {
                // Hide all normal hand inputs for doublers
                basicHandInfo.style.display = 'none';
                wrapSection.style.display = 'none';
            } else {
                // Show all inputs for normal hands
                basicHandInfo.style.display = 'block';
                wrapSection.style.display = 'block';
            }
        }
        
        function handleDoubler() {
            // Set flag so the NEXT hand will be doubled
            nextHandIsDoubled = true;
            
            alert(`DOUBLER! Everyone passed.

Next hand will be worth 2x points!

Dealer redeals now...`);
            
            clearHand();
        }
        
        function updateCurrentHandTitle() {
            const handTitle = document.getElementById('currentHandTitle');
            if (!handTitle) return;
            
            let title = `Current Hand`;
            let isDoubler = false;
            
            if (nextHandIsDoubled && currentHandMultiplier > 1) {
                // This shouldn't happen, but just in case
                title += ` - DOUBLED (2x)`;
                isDoubler = true;
            } else if (nextHandIsDoubled) {
                // Previous hand was a doubler, this hand will be doubled
                title += ` - DOUBLED (2x)`;
                isDoubler = true;
            } else if (currentHandMultiplier > 1) {
                // Currently scoring a doubled hand
                title += ` - DOUBLED (2x)`;
                isDoubler = true;
            }
            
            handTitle.textContent = title;
            
            // Add/remove visual styling
            if (isDoubler) {
                handTitle.classList.add('doubler-indicator');
            } else {
                handTitle.classList.remove('doubler-indicator');
            }
        }

        function clearHand() {
            document.getElementById('picker').value = '';
            document.getElementById('partner').value = '';
            document.getElementById('pickerPoints').value = '';
            document.getElementById('wrapped').checked = false;
            document.getElementById('reWrapped').checked = false;
            document.getElementById('wrappedBy').value = '';
            document.getElementById('reWrappedBy').value = '';
            document.getElementById('calledSuit').value = '';
            document.getElementById('handDealer').value = '';
            document.getElementById('isDoubler').checked = false;
            updatePickerPartnerOptions();
            updateHandTypeOptions();
            updateCurrentHandTitle();
        }

        function newGame() {
            if (confirm('Start a new game? This will reset all scores and sessions.')) {
                hands = [];
                currentHand = 1;
                playerStats = {};
                fiveHandSessions = [];
                currentSessionNumber = 1;
                totalPlayerDebts = {};
                nextHandIsDoubled = false;
                currentHandMultiplier = 1;
                currentHandDealer = null;
                document.getElementById('setup').classList.remove('hidden');
                document.getElementById('gameSection').classList.add('hidden');
                document.getElementById('settlementSection').style.display = 'none';
                updateScoreTable();
                updateStatsTable();
            }
        }

        function exportGame() {
            if (hands.length === 0) {
                alert('No hands to export!');
                return;
            }
            
            let csv = 'Hand,';
            csv += players.join(',') + ',Details\n';
            
            const totals = {};
            players.forEach(p => totals[p] = 0);
            
            hands.forEach(hand => {
                csv += `${hand.number},`;
                csv += players.map(p => {
                    totals[p] += hand.scores[p];
                    return `$${hand.scores[p]}`;
                }).join(',');
                csv += `,"${hand.description}"\n`;
            });
            
            csv += 'TOTAL,';
            csv += players.map(p => `$${totals[p]}`).join(',') + ',\n';
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sheepshead_scores_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCustomPlayer();
            }
        });
        
        // Initialize preset player checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('#presetPlayers input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedPlayers);
            });
        });
        
        function updateSelectedPlayers() {
            const checkboxes = document.querySelectorAll('#presetPlayers input[type="checkbox"]');
            allPlayers = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    allPlayers.push({ name: checkbox.value });
                }
            });
            
            // Update active players (excluding sitting out)
            players = allPlayers.filter(p => p.name !== sittingOut).map(p => p.name);
            
            // Show/hide dealer and sitting controls
            const dealerSittingControls = document.getElementById('dealerSittingControls');
            const sittingOutControl = document.getElementById('sittingOutControl');
            
            if (allPlayers.length > 5) {
                dealerSittingControls.style.display = 'block';
                sittingOutControl.style.display = 'block';
                updateSittingOutOptions();
            } else {
                dealerSittingControls.style.display = 'none';
                sittingOutControl.style.display = 'none';
                sittingOut = null;
            }
            
            updatePlayersList();
            updateStartButton();
        }
        
        function updateDealerOptions() {
            // Dealer is now selected per hand, not in setup
            // This function is no longer needed
        }
        
        function updateSittingOutOptions() {
            const sittingSelect = document.getElementById('sittingOut');
            sittingSelect.innerHTML = '<option value="">No one sitting out</option>' +
                allPlayers.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            
            sittingSelect.onchange = function() {
                sittingOut = this.value || null;
                players = allPlayers.filter(p => p.name !== sittingOut).map(p => p.name);
                updatePlayersList();
                updateStartButton();
            };
        }
        
        function initializeSessionTracking() {
            fiveHandSessions = [];
            currentSessionNumber = 1;
            totalPlayerDebts = {};
            nextHandIsDoubled = false;
            currentHandMultiplier = 1;
            currentHandDealer = null;
            players.forEach(player => {
                totalPlayerDebts[player] = 0;
            });
            updateScoreTable(); // Update the session info display
        }
        
        function completeSession() {
            // Calculate session totals
            const sessionTotals = {};
            players.forEach(p => sessionTotals[p] = 0);
            
            const sessionStartHand = (currentSessionNumber - 1) * 5 + 1;
            const sessionHands = hands.filter(h => h.number >= sessionStartHand && h.number < sessionStartHand + 5);
            
            sessionHands.forEach(hand => {
                players.forEach(player => {
                    sessionTotals[player] += hand.scores[player];
                });
            });
            
            // Store the completed session
            fiveHandSessions.push({
                sessionNumber: currentSessionNumber,
                totals: { ...sessionTotals },
                hands: [...sessionHands]
            });
            
            // Update running debt totals
            players.forEach(player => {
                totalPlayerDebts[player] += sessionTotals[player];
            });
            
            // Move to next session
            currentSessionNumber++;
            
            // Update displays
            updateSettlementTable();
            updateScoreTable();
            
            // Show settlement alert
            showSessionSettlementAlert(sessionTotals);
        }
        
        function showSessionSettlementAlert(sessionTotals) {
            let message = `Session ${currentSessionNumber - 1} Complete!\\n\\nSettlement for this session:\\n`;
            
            const debts = Object.entries(sessionTotals)
                .filter(([player, amount]) => amount < 0)
                .sort((a, b) => a[1] - b[1]); // Most debt first
            
            const credits = Object.entries(sessionTotals)
                .filter(([player, amount]) => amount > 0)
                .sort((a, b) => b[1] - a[1]); // Highest credit first
            
            debts.forEach(([player, amount]) => {
                message += `${player}: Owes $${Math.abs(amount)} to kitty\\n`;
            });
            
            credits.forEach(([player, amount]) => {
                message += `${player}: Collects $${amount} from kitty\\n`;
            });
            
            message += `\\nStarting fresh session ${currentSessionNumber}...`;
            
            alert(message);
        }
        
        function updateSettlementTable() {
            const settlementSection = document.getElementById('settlementSection');
            const tbody = document.getElementById('settlementBody');
            
            if (fiveHandSessions.length === 0) {
                settlementSection.style.display = 'none';
                return;
            }
            
            settlementSection.style.display = 'block';
            
            let html = '';
            players.forEach(player => {
                const totalAmount = totalPlayerDebts[player] || 0;
                const statusClass = totalAmount < 0 ? 'debt' : (totalAmount > 0 ? 'credit' : '');
                const statusText = totalAmount < 0 ? `Owes $${Math.abs(totalAmount)}` : (totalAmount > 0 ? `Won $${totalAmount}` : 'Even');
                
                html += `<tr>
                    <td><strong>${player}</strong></td>
                    <td class="${statusClass}">${statusText}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        document.getElementById('pickerPoints').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scoreHand();
            }
        });
        
        function generateSessionId() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
            return `session_${dateStr}_${timeStr}`;
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'history') {
                loadHistoricalData();
            } else if (tabName === 'stats') {
                calculateAllTimeStats();
            }
        }
        
        function saveSession() {
            if (hands.length === 0) {
                alert('No hands to save!');
                return;
            }
            
            const sessionData = {
                id: currentSessionId,
                date: new Date().toISOString().split('T')[0],
                startTime: gameStartTime,
                endTime: new Date().toISOString(),
                players: [...players],
                hands: [...hands],
                finalScores: {},
                totalHands: hands.length
            };
            
            // Calculate final scores (total across all sessions)
            players.forEach(player => {
                sessionData.finalScores[player] = totalPlayerDebts[player] || 0;
            });
            
            // Also store current session scores if in progress
            const currentSessionScores = {};
            const sessionStartHand = (currentSessionNumber - 1) * 5 + 1;
            const currentSessionHands = hands.filter(h => h.number >= sessionStartHand);
            
            players.forEach(player => {
                currentSessionScores[player] = currentSessionHands.reduce((total, hand) => {
                    return total + (hand.scores[player] || 0);
                }, 0);
            });
            
            sessionData.currentSessionScores = currentSessionScores;
            
            // Save to localStorage
            const existingSessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const existingIndex = existingSessions.findIndex(s => s.id === currentSessionId);
            
            if (existingIndex >= 0) {
                existingSessions[existingIndex] = sessionData;
            } else {
                existingSessions.push(sessionData);
            }
            
            localStorage.setItem('sheepsheadSessions', JSON.stringify(existingSessions));
            
            // Add session tracking data
            sessionData.fiveHandSessions = fiveHandSessions;
            sessionData.totalPlayerDebts = totalPlayerDebts;
            sessionData.currentSessionNumber = currentSessionNumber;
            
            // Update player profiles
            updatePlayerProfiles(sessionData);
            
            console.log('Session saved:', sessionData);
            alert('Session saved successfully!');
        }
        
        function updatePlayerProfiles(sessionData) {
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            
            sessionData.players.forEach(player => {
                if (!profiles[player]) {
                    profiles[player] = {
                        allTimeRecord: {wins: 0, losses: 0},
                        totalSessions: 0,
                        totalHands: 0,
                        allTimeScore: 0,
                        timesPickedTotal: 0,
                        timesPartnerTotal: 0,
                        lastPlayed: null,
                        sessions: []
                    };
                }
                
                const profile = profiles[player];
                const playerStats = calculatePlayerStatsForSession(sessionData, player);
                
                profile.allTimeRecord.wins += playerStats.wins;
                profile.allTimeRecord.losses += playerStats.losses;
                profile.totalSessions += 1;
                profile.totalHands += playerStats.handsPlayed;
                profile.allTimeScore += sessionData.finalScores[player];
                profile.timesPickedTotal += playerStats.timesPicked;
                profile.timesPartnerTotal += playerStats.timesPartner;
                profile.lastPlayed = sessionData.date;
                
                if (!profile.sessions.includes(sessionData.id)) {
                    profile.sessions.push(sessionData.id);
                }
            });
            
            localStorage.setItem('sheepsheadProfiles', JSON.stringify(profiles));
        }
        
        function calculatePlayerStatsForSession(sessionData, player) {
            const stats = {
                wins: 0,
                losses: 0,
                timesPicked: 0,
                timesPartner: 0,
                handsPlayed: sessionData.hands.length
            };
            
            sessionData.hands.forEach(hand => {
                const pickerTeamWon = hand.points >= 61;
                
                if (hand.picker === player) {
                    stats.timesPicked++;
                    if (pickerTeamWon) stats.wins++;
                    else stats.losses++;
                } else if (hand.partner === player) {
                    stats.timesPartner++;
                    if (pickerTeamWon) stats.wins++;
                    else stats.losses++;
                } else {
                    if (!pickerTeamWon) stats.wins++;
                    else stats.losses++;
                }
            });
            
            return stats;
        }
        
        function loadHistoricalData() {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const sessionsList = document.getElementById('sessionsList');
            
            console.log('Loading historical data, found sessions:', sessions.length);
            
            if (sessions.length === 0) {
                sessionsList.innerHTML = '<p>No saved sessions found. Play some games and click "Save Session" to see history here.</p>';
                return;
            }
            
            sessions.sort((a, b) => new Date(b.endTime) - new Date(a.endTime));
            
            let html = '';
            sessions.forEach(session => {
                const date = new Date(session.endTime).toLocaleDateString();
                const time = new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const winner = Object.entries(session.finalScores).reduce((a, b) => session.finalScores[a[0]] > session.finalScores[b[0]] ? a : b);
                
                html += `
                    <div class="session-item" onclick="viewSessionDetail('${session.id}')">
                        <div class="session-meta">
                            <strong>${date} at ${time}</strong>
                            <span>${session.totalHands} hands</span>
                        </div>
                        <div class="session-players">
                            Players: ${session.players.join(', ')}
                        </div>
                        <div style="font-size: 14px; color: #4CAF50; margin-top: 5px;">
                            Winner: ${winner[0]} ($${winner[1]})
                        </div>
                    </div>
                `;
            });
            
            sessionsList.innerHTML = html;
        }
        
        function viewSessionDetail(sessionId) {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);
            
            if (!session) return;
            
            const modal = document.getElementById('sessionModal');
            const detail = document.getElementById('sessionDetail');
            
            const date = new Date(session.endTime).toLocaleDateString();
            const startTime = new Date(session.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const endTime = new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let html = `
                <h2>Session Details - ${date}</h2>
                <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Total Hands:</strong> ${session.totalHands}</p>
                
                <h3>Final Scores</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            ${session.players.map(p => `<th>${p}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            ${session.players.map(p => {
                                const score = session.finalScores[p];
                                return `<td class="${score > 0 ? 'positive' : 'negative'}"><strong>$${score}</strong></td>`;
                            }).join('')}
                        </tr>
                    </tbody>
                </table>
                
                <h3>Hand History</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Hand</th>
                            ${session.players.map(p => `<th>${p}</th>`).join('')}
                            <th>Called Suit</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            session.hands.forEach(hand => {
                html += `
                    <tr>
                        <td>${hand.number}</td>
                        ${session.players.map(p => {
                            const score = hand.scores[p] || 0;
                            return `<td class="${score > 0 ? 'positive' : 'negative'}">$${score}</td>`;
                        }).join('')}
                        <td>${hand.calledSuit || 'N/A'}</td>
                        <td style="font-size: 12px;">${hand.description}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <button onclick="deleteSession('${sessionId}')">Delete Session</button>
                    <button onclick="exportSession('${sessionId}')">Export Session</button>
                </div>
            `;
            
            detail.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closeSessionModal() {
            document.getElementById('sessionModal').style.display = 'none';
        }
        
        function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;
            
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const updatedSessions = sessions.filter(s => s.id !== sessionId);
            localStorage.setItem('sheepsheadSessions', JSON.stringify(updatedSessions));
            
            closeSessionModal();
            loadHistoricalData();
            alert('Session deleted successfully!');
        }
        
        function calculateAllTimeStats() {
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const statsDiv = document.getElementById('allTimeStats');
            
            console.log('Calculating all-time stats, profiles:', Object.keys(profiles).length, 'sessions:', sessions.length);
            
            if (Object.keys(profiles).length === 0) {
                statsDiv.innerHTML = '<p>No player data available. Play some games and click "Save Session" to build statistics!</p>';
                return;
            }
            
            const playerData = Object.entries(profiles).map(([name, profile]) => ({
                name,
                ...profile,
                winPercentage: profile.totalHands > 0 ? ((profile.allTimeRecord.wins / profile.totalHands) * 100).toFixed(1) : 0,
                avgScorePerHand: profile.totalHands > 0 ? (profile.allTimeScore / profile.totalHands).toFixed(2) : 0
            })).sort((a, b) => b.allTimeScore - a.allTimeScore);
            
            // Calculate suit calling statistics
            const suitStats = calculateSuitCallingStats(sessions);
            
            let html = `
                <h3>Player Rankings</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Total Winnings</th>
                            <th>Sessions</th>
                            <th>Record</th>
                            <th>Win %</th>
                            <th>Avg/Hand</th>
                            <th>Times Picked</th>
                            <th>Times Partner</th>
                            <th>Last Played</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            playerData.forEach((player, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><strong>${player.name}</strong></td>
                        <td class="${player.allTimeScore > 0 ? 'positive' : 'negative'}"><strong>$${player.allTimeScore}</strong></td>
                        <td>${player.totalSessions}</td>
                        <td>${player.allTimeRecord.wins}-${player.allTimeRecord.losses}</td>
                        <td>${player.winPercentage}%</td>
                        <td class="${parseFloat(player.avgScorePerHand) > 0 ? 'positive' : 'negative'}">$${player.avgScorePerHand}</td>
                        <td>${player.timesPickedTotal}</td>
                        <td>${player.timesPartnerTotal}</td>
                        <td>${player.lastPlayed || 'Never'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3 style="margin-top: 30px;">Called Suit Statistics</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div class="scoreboard">
                        <h4>Overall Suit Performance</h4>
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Suit</th>
                                    <th>Times Called</th>
                                    <th>Win Rate</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.entries(suitStats.overall).forEach(([suit, stats]) => {
                const winRate = stats.total > 0 ? ((stats.wins / stats.total) * 100).toFixed(1) : 0;
                html += `
                    <tr>
                        <td><strong>${suit}</strong></td>
                        <td>${stats.total}</td>
                        <td class="${parseFloat(winRate) > 50 ? 'positive' : 'negative'}">${winRate}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="scoreboard">
                        <h4>Player Suit Preferences</h4>
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Favorite Suit</th>
                                    <th>Success Rate</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.entries(suitStats.byPlayer).forEach(([player, suits]) => {
                const favoriteData = Object.entries(suits)
                    .reduce((max, [suit, stats]) => stats.total > max.total ? {suit, ...stats} : max, {suit: 'None', total: 0, wins: 0});
                const successRate = favoriteData.total > 0 ? ((favoriteData.wins / favoriteData.total) * 100).toFixed(1) : 0;
                
                html += `
                    <tr>
                        <td><strong>${player}</strong></td>
                        <td>${favoriteData.suit} (${favoriteData.total}x)</td>
                        <td class="${parseFloat(successRate) > 50 ? 'positive' : 'negative'}">${successRate}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="scoreboard">
                        <h4>Wrap/Re-wrap Statistics</h4>
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Times Wrapped</th>
                                    <th>Wrap Success</th>
                                    <th>Times Re-wrapped</th>
                                    <th>Re-wrap Success</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            const wrapStats = calculateWrapStats(sessions);
            Object.entries(wrapStats).forEach(([player, stats]) => {
                const wrapSuccess = stats.wraps > 0 ? ((stats.wrapWins / stats.wraps) * 100).toFixed(1) : 0;
                const rewrapSuccess = stats.rewraps > 0 ? ((stats.rewrapWins / stats.rewraps) * 100).toFixed(1) : 0;
                
                html += `
                    <tr>
                        <td><strong>${player}</strong></td>
                        <td>${stats.wraps}</td>
                        <td class="${parseFloat(wrapSuccess) > 50 ? 'positive' : 'negative'}">${wrapSuccess}%</td>
                        <td>${stats.rewraps}</td>
                        <td class="${parseFloat(rewrapSuccess) > 50 ? 'positive' : 'negative'}">${rewrapSuccess}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            statsDiv.innerHTML = html;
        }
        
        function calculateWrapStats(sessions) {
            const wrapStats = {};
            
            // Initialize all players
            sessions.forEach(session => {
                session.players.forEach(player => {
                    if (!wrapStats[player]) {
                        wrapStats[player] = {
                            wraps: 0,
                            wrapWins: 0,
                            rewraps: 0,
                            rewrapWins: 0
                        };
                    }
                });
            });
            
            sessions.forEach(session => {
                session.hands.forEach(hand => {
                    const won = hand.points >= 61;
                    
                    if (hand.wrapped && hand.wrappedBy) {
                        const wrapper = hand.wrappedBy;
                        if (wrapStats[wrapper]) {
                            wrapStats[wrapper].wraps++;
                            if (won) wrapStats[wrapper].wrapWins++;
                        }
                    }
                    
                    if (hand.reWrapped && hand.reWrappedBy) {
                        const rewrapper = hand.reWrappedBy;
                        if (wrapStats[rewrapper]) {
                            wrapStats[rewrapper].rewraps++;
                            if (won) wrapStats[rewrapper].rewrapWins++;
                        }
                    }
                });
            });
            
            return wrapStats;
        }
        
        function calculateSuitCallingStats(sessions) {
            const overall = {
                'Hearts': {wins: 0, total: 0},
                'Spades': {wins: 0, total: 0},
                'Clubs': {wins: 0, total: 0}
            };
            
            const byPlayer = {};
            
            sessions.forEach(session => {
                session.hands.forEach(hand => {
                    if (hand.calledSuit) {
                        const suit = hand.calledSuit;
                        const won = hand.points >= 61;
                        
                        // Overall stats
                        if (!overall[suit]) overall[suit] = {wins: 0, total: 0};
                        overall[suit].total++;
                        if (won) overall[suit].wins++;
                        
                        // Player stats
                        const picker = hand.picker;
                        if (!byPlayer[picker]) byPlayer[picker] = {};
                        if (!byPlayer[picker][suit]) byPlayer[picker][suit] = {wins: 0, total: 0};
                        byPlayer[picker][suit].total++;
                        if (won) byPlayer[picker][suit].wins++;
                    }
                });
            });
            
            return {overall, byPlayer};
        }
        
        function exportAllData() {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            
            const data = {
                sessions,
                profiles,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sheepshead_all_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function exportSession(sessionId) {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);
            
            if (!session) return;
            
            const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sheepshead_session_${session.date}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function importData() {
            document.getElementById('importFile').click();
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.sessions && Array.isArray(data.sessions)) {
                        const existingSessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
                        const merged = [...existingSessions];
                        
                        data.sessions.forEach(newSession => {
                            const existingIndex = merged.findIndex(s => s.id === newSession.id);
                            if (existingIndex >= 0) {
                                merged[existingIndex] = newSession;
                            } else {
                                merged.push(newSession);
                            }
                        });
                        
                        localStorage.setItem('sheepsheadSessions', JSON.stringify(merged));
                    }
                    
                    if (data.profiles && typeof data.profiles === 'object') {
                        const existingProfiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
                        const mergedProfiles = { ...existingProfiles, ...data.profiles };
                        localStorage.setItem('sheepsheadProfiles', JSON.stringify(mergedProfiles));
                    }
                    
                    alert('Data imported successfully!');
                    loadHistoricalData();
                    calculateAllTimeStats();
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('sessionModal');
            if (event.target === modal) {
                closeSessionModal();
            }
        }
        
        function debugStorage() {
            const sessions = JSON.parse(localStorage.getItem('sheepsheadSessions') || '[]');
            const profiles = JSON.parse(localStorage.getItem('sheepsheadProfiles') || '{}');
            
            console.log('=== STORAGE DEBUG ===');
            console.log('Sessions in localStorage:', sessions.length);
            console.log('Sessions data:', sessions);
            console.log('Profiles in localStorage:', Object.keys(profiles).length);
            console.log('Profiles data:', profiles);
            console.log('Current game state:');
            console.log('- Players:', players);
            console.log('- Hands:', hands.length);
            console.log('- Current session:', currentSessionNumber);
            console.log('- Total player debts:', totalPlayerDebts);
            
            alert(`Storage Debug:
Sessions: ${sessions.length}
Profiles: ${Object.keys(profiles).length}
Current hands: ${hands.length}
Check console for detailed info.`);
        }
        
        function initializePlayerStats() {
            playerStats = {};
            players.forEach(player => {
                playerStats[player] = {
                    wins: 0,
                    losses: 0,
                    timesPicked: 0,
                    timesPartner: 0,
                    totalScore: 0,
                    handsPlayed: 0,
                    doublersWon: 0
                };
            });
        }
        
        function updatePlayerStats(hand) {
            const pickerTeamWon = hand.points >= 61;
            const isDoubler = hand.multiplier > 1;
            
            players.forEach(player => {
                const stats = playerStats[player];
                stats.handsPlayed++;
                stats.totalScore += hand.scores[player];
                
                if (player === hand.picker) {
                    stats.timesPicked++;
                    if (pickerTeamWon) {
                        stats.wins++;
                        if (isDoubler) stats.doublersWon++;
                    } else {
                        stats.losses++;
                    }
                } else if (player === hand.partner) {
                    stats.timesPartner++;
                    if (pickerTeamWon) {
                        stats.wins++;
                        if (isDoubler) stats.doublersWon++;
                    } else {
                        stats.losses++;
                    }
                } else {
                    if (!pickerTeamWon) stats.wins++;
                    else stats.losses++;
                }
            });
        }
        
        function updateStatsTable() {
            const tbody = document.getElementById('statsBody');
            
            let html = '';
            players.forEach(player => {
                const stats = playerStats[player];
                const winPercentage = stats.handsPlayed > 0 ? 
                    ((stats.wins / stats.handsPlayed) * 100).toFixed(1) : '0.0';
                const avgScore = stats.handsPlayed > 0 ? 
                    (stats.totalScore / stats.handsPlayed).toFixed(1) : '0.0';
                
                html += `<tr>
                    <td><strong>${player}</strong></td>
                    <td>${stats.wins}-${stats.losses}</td>
                    <td>${winPercentage}%</td>
                    <td>${stats.timesPicked}</td>
                    <td>${stats.timesPartner}</td>
                    <td><strong>${stats.doublersWon}</strong></td>
                    <td class="${parseFloat(avgScore) > 0 ? 'positive' : 'negative'}">$${avgScore}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }
    </script>
</body>
</html>